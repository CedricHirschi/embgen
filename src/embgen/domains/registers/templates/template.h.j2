/**
 * @file {{ name | lower | replace(' ', '_') }}.h
 * @brief Register map definitions for {{ name }}
 *
 * This file is auto-generated by embgen. Do not edit manually.
 */

#ifndef {{ name | upper | replace(' ', '_') }}_H
#define {{ name | upper | replace(' ', '_') }}_H

#include <assert.h>

#ifndef {{ name | upper | replace(' ', '_') }}_STANDALONE
#define {{ name | upper | replace(' ', '_') }}_STANDALONE 0
#endif

#if !{{ name | upper | replace(' ', '_') }}_STANDALONE
#include "reg_common.h"
#else
#include <stdint.h>

#define REG_FIELD_SIZE 2

#if REG_FIELD_SIZE == 1
typedef uint8_t reg_field_t;
#define REG_HEADER_SIZE 2 // [addr|rw, length]
#elif REG_FIELD_SIZE == 2
typedef uint16_t reg_field_t;
#define REG_HEADER_SIZE 4 // [addr_h|rw, addr_l, len_h, len_l]
#elif REG_FIELD_SIZE == 4
typedef uint32_t reg_field_t;
#define REG_HEADER_SIZE 8 // [addr_hh|rw, addr_hl, addr_lh, addr_ll, len_hh, len_hl, len_lh, len_ll]
#else
#error "Unsupported REG_FIELD_SIZE"
#endif

typedef enum {
  REG_ATTR_NONE = 0,
  REG_ATTR_READONLY = (1 << 0),
  REG_ATTR_WRITEONLY = (1 << 1),
} reg_attr_t;
#endif // {{ name | upper | replace(' ', '_') }}_STANDALONE

/* ============================================================================
 * Register Map Configuration
 * ========================================================================== */

/** @brief Number of registers in the register map */
#define {{ name | upper | replace(' ', '_') }}_SIZE {{ regmap|length }}

/* ============================================================================
 * Register Addresses
 * ========================================================================== */

typedef enum {{ name | lower | replace(' ', '_') }}_address {
{% for register in regmap %}
    {{ name | upper | replace(' ', '_') }}_ADDR_{{ register.name | upper | replace(' ', '_') }} = 0x{{ '%X' % register.address }},{% if register.description %} /**< {{ register.description }} */{% endif %}

{% endfor  %}
} {{ name | lower | replace(' ', '_') }}_address_t;

/* ============================================================================
 * Register Attributes
 * ========================================================================== */

static const uint8_t {{ name | upper | replace(' ', '_') }}_ATTRS[{{ name | upper | replace(' ', '_') }}_SIZE] = {
{% for register in regmap %}
{% set ns = namespace(has_read=false, has_write=false) %}
{% if register.access.value in ['ro', 'rolh'] %}
{% set ns.has_read = true %}
{% elif register.access.value in ['wo', 'wosc'] %}
{% set ns.has_write = true %}
{% else %}
{% set ns.has_read = true %}
{% set ns.has_write = true %}
{% endif %}
{% if ns.has_read and not ns.has_write %}
    [{{ name | upper | replace(' ', '_') }}_ADDR_{{ register.name | upper | replace(' ', '_') }}] = REG_ATTR_READONLY,
{% elif ns.has_write and not ns.has_read %}
    [{{ name | upper | replace(' ', '_') }}_ADDR_{{ register.name | upper | replace(' ', '_') }}] = REG_ATTR_WRITEONLY,
{% else %}
    [{{ name | upper | replace(' ', '_') }}_ADDR_{{ register.name | upper | replace(' ', '_') }}] = REG_ATTR_NONE,
{% endif %}
{% endfor  %}
};

/* ============================================================================
 * Field Enumerations
 * ========================================================================== */
{% for register in regmap %}
{% for field in register.bitfields %}
{% if field.enums %}

/** @brief Enumeration values for {{ register.name }}.{{ field.name }} field */
typedef enum {{ name | lower | replace(' ', '_') }}_{{ register.name | lower | replace(' ', '_') }}_{{ field.name | lower | replace(' ', '_') }} {
{% for enum in field.enums %}
    {{ name | upper | replace(' ', '_') }}_{{ register.name | upper | replace(' ', '_') }}_{{ field.name | upper | replace(' ', '_') }}_{{ enum.name | upper | replace(' ', '_') }} = {{ enum.value }},{% if enum.description %} /**< {{ enum.description }} */{% endif %}

{% endfor %}
} {{ name | lower | replace(' ', '_') }}_{{ register.name | lower | replace(' ', '_') }}_{{ field.name | lower | replace(' ', '_') }}_t;
{% endif %}
{% endfor %}
{% endfor %}

/* ============================================================================
 * Bit Field Offset Macros
 * ========================================================================== */
{% for register in regmap %}

/* {{ register.name }} Register Offsets */
{% for field in register.bitfields %}
#define {{ name | upper | replace(' ', '_') }}_{{ register.name | upper | replace(' ', '_') }}_{{ field.name | upper | replace(' ', '_') }}_OFFSET {{ field.offset }}
{% endfor %}
{% endfor %}

/* ============================================================================
 * Bit Field Width Macros
 * ========================================================================== */
{% for register in regmap %}

/* {{ register.name }} Register Widths */
{% for field in register.bitfields %}
#define {{ name | upper | replace(' ', '_') }}_{{ register.name | upper | replace(' ', '_') }}_{{ field.name | upper | replace(' ', '_') }}_WIDTH {{ field.width }}
{% endfor %}
{% endfor %}

/* ============================================================================
 * Bit Field Mask Macros
 * ========================================================================== */
{% for register in regmap %}

/* {{ register.name }} Register Masks */
{% for field in register.bitfields %}
#define {{ name | upper | replace(' ', '_') }}_{{ register.name | upper | replace(' ', '_') }}_{{ field.name | upper | replace(' ', '_') }}_MASK (((1U << {{ field.width }}) - 1) << {{ field.offset }})
{% endfor %}
{% endfor %}

/* ============================================================================
 * Reset Value Macros
 * ========================================================================== */
{% for register in regmap %}

/* {{ register.name }} Register Reset Values */
{% for field in register.bitfields %}
#define {{ name | upper | replace(' ', '_') }}_{{ register.name | upper | replace(' ', '_') }}_{{ field.name | upper | replace(' ', '_') }}_RESET {{ field.reset }}
{% endfor %}
{% endfor %}

{% for register in regmap %}
{% set total_bits = namespace(value=0) %}
{% for field in register.bitfields %}
{% set total_bits.value = [total_bits.value, field.offset + field.width] | max %}
{% endfor %}
/** @brief Reset value for entire {{ register.name }} register */
#define {{ name | upper | replace(' ', '_') }}_{{ register.name | upper | replace(' ', '_') }}_RESET ({% for field in register.bitfields %}({{ field.reset }}U << {{ field.offset }}){% if not loop.last %} | {% endif %}{% endfor %})
{% endfor %}

/* ============================================================================
 * Field Accessor Macros
 * ========================================================================== */
{% for register in regmap %}

/* {{ register.name }} Register Accessors */
{% for field in register.bitfields %}
/** @brief Get {{ field.name }} field from {{ register.name }} register{% if field.description %} - {{ field.description }}{% endif %} */
#define {{ name | upper | replace(' ', '_') }}_{{ register.name | upper | replace(' ', '_') }}_GET_{{ field.name | upper | replace(' ', '_') }}(reg) \
    (((reg) >> {{ field.offset }}) & ((1U << {{ field.width }}) - 1))

/** @brief Set {{ field.name }} field in {{ register.name }} register */
#define {{ name | upper | replace(' ', '_') }}_{{ register.name | upper | replace(' ', '_') }}_SET_{{ field.name | upper | replace(' ', '_') }}(reg, val) \
    (((reg) & ~(((1U << {{ field.width }}) - 1) << {{ field.offset }})) | (((val) & ((1U << {{ field.width }}) - 1)) << {{ field.offset }}))

{% endfor %}
{% endfor %}

/* ============================================================================
 * Register Structures
 * ========================================================================== */
{% for register in regmap %}
{% set total_bits = namespace(value=0) %}
{% set sorted_fields = register.bitfields | sort(attribute='offset') %}
{% for field in sorted_fields %}
{% set total_bits.value = [total_bits.value, field.offset + field.width] | max %}
{% endfor %}

/**
 * @brief {{ register.name }} Register (0x{{ '%X' % register.address }})
{% if register.description %}
 * {{ register.description }}
{% endif %}
 * Access: {{ register.access.value | upper }}
 */
struct __attribute__((aligned(REG_FIELD_SIZE))) {{ name | lower | replace(' ', '_') }}_{{ register.name | lower | replace(' ', '_') }} {
{% set prev_end = namespace(value=0) %}
{% set reserved_count = namespace(value=0) %}
{% for field in sorted_fields %}
{% if field.offset > prev_end.value %}
{% set padding = field.offset - prev_end.value %}
    reg_field_t _reserved{{ reserved_count.value }} : {{ padding }}; /**< Reserved bits [{{ prev_end.value }}:{{ field.offset - 1 }}] */
{% set reserved_count.value = reserved_count.value + 1 %}
{% endif %}
    reg_field_t {{ field.name | lower | replace(' ', '_') }} : {{ field.width }}; /**< {% if field.description %}{{ field.description }} {% endif %}[{{ field.offset }}:{{ field.offset + field.width - 1 }}] */
{% set prev_end.value = field.offset + field.width %}
{% endfor %}
};
static_assert(sizeof(struct {{ name | lower | replace(' ', '_') }}_{{ register.name | lower | replace(' ', '_') }}) == REG_FIELD_SIZE, "{{ name | lower | replace(' ', '_') }}_{{ register.name | lower | replace(' ', '_') }} size mismatch");

{% endfor %}

/* ============================================================================
 * Register Union Types (for raw access)
 * ========================================================================== */
{% for register in regmap %}

/** @brief Union for {{ register.name }} register - allows raw and bitfield access */
typedef union {{ name | lower | replace(' ', '_') }}_{{ register.name | lower | replace(' ', '_') }}_u {
    reg_field_t raw; /**< Raw register value */
    struct {{ name | lower | replace(' ', '_') }}_{{ register.name | lower | replace(' ', '_') }} bits; /**< Bitfield access */
} {{ name | lower | replace(' ', '_') }}_{{ register.name | lower | replace(' ', '_') }}_t;
{% endfor %}

/* ============================================================================
 * Register Map Implementation Struct
 * ========================================================================== */

/** @brief Complete register map structure for {{ name }} */
typedef struct {{ name | lower | replace(' ', '_') }} {
{% for register in regmap %}
    union {{ name | lower | replace(' ', '_') }}_{{ register.name | lower | replace(' ', '_') }}_u {{ register.name | lower | replace(' ', '_') }};{% if register.description %} /**< {{ register.description }} */{% endif %}

{% endfor %}
} {{ name | lower | replace(' ', '_') }}_t;

/* ============================================================================
 * Default Initialization Macro
 * ========================================================================== */

/** @brief Initialize register map with reset values */
#define {{ name | upper | replace(' ', '_') }}_INIT ({{ name | lower | replace(' ', '_') }}_t){ {% for register in regmap %}.{{ register.name | lower | replace(' ', '_') }}.raw = {{ name | upper | replace(' ', '_') }}_{{ register.name | upper | replace(' ', '_') }}_RESET{% if not loop.last %}, {% endif %}{% endfor %} }

#endif /* {{ name | upper | replace(' ', '_') }}_H */
